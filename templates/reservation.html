<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karaoke Room Reservation System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css">
    <!-- Removed flatpickr - using FullCalendar only -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/reservation.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/enhanced-calendar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/improved-layout.css') }}">
    <!-- tippy removed: using simple title-based tooltips instead -->
</head>

<body class="lang-en">
        <script>
            window.initialSelectedDate = "{{ selected_date }}";
        </script>
    <div class="main-container">
        <!-- Header -->
        <header class="header">
            <h1>
                <span class="en">Karaoke Room Reservation System</span>
                <span class="zh">卡拉OK房间预订系统</span>
            </h1>
            <div class="header-actions">
                <button id="language-toggle" class="btn btn-sm btn-outline-light">中文</button>
            </div>
        </header>

    <!-- Sidebar (Calendar + Idle Area) -->
    <div class="sidebar">
            <!-- Calendar -->
            <div class="calendar-container">
                <div class="calendar-controls simple d-flex justify-content-between align-items-center">
                    <button class="btn btn-sm btn-outline-secondary" id="prev-day-btn">◀</button>
                    <button class="btn btn-sm btn-outline-secondary" id="today-btn">Today</button>
                    <button class="btn btn-sm btn-outline-secondary" id="next-day-btn">▶</button>
                </div>
                <div class="selected-date-display text-center mb-1"><span id="selected-date-label"></span></div>
                <div id="calendar"></div>
            </div>

            <!-- Idle Reservations (renamed to match improved-layout.css expectation) -->
            <div class="idle-area-container">
                <div class="idle-area-header">
                    <span class="en">Idle Reservations</span>
                    <span class="zh">闲置预订</span>
                </div>
                <div id="idle-area" class="idle-area">
                    {% for reservation in idle_reservations %}
                    <div class="reservation-card" data-reservation-id="{{ reservation.id }}" data-room-id="idle"
                        data-start-time="{{ reservation.start_time }}" data-end-time="{{ reservation.end_time }}"
                        data-duration="{{ reservation.duration }}">
                        <div class="time-indicator">
                            <span class="time-range">{{ reservation.start_time }} - {{ reservation.end_time }}</span>
                        </div>
                        <div class="content">
                            <div class="name-row">
                                <strong>{{ reservation.contact_name }}</strong>
                                <span class="people-count">{{ reservation.num_people }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Content Area with Room Timelines -->
        <div class="content-area">
            <!-- Room Timelines -->
            <div class="rooms-container">
                {% for room in rooms %}
                <div class="room-container">
                    <div class="room-header">
                        <span class="en">Room {{ room.id }}</span>
                        <span class="zh">房间 {{ room.id }}</span>
                    </div>
                    <div class="room-timeline-wrapper">
                        <div class="time-labels">
                            {% set start_hour = 11 %}
                            {% set end_hour = 25 %}
                            {% for h in range(start_hour, end_hour) %}
                            <div class="time-label">{{ (h-1) % 12 + 1 }}:00 {{ 'AM' if h < 12 or h==24 else 'PM' }}</div>
                            <div class="time-label">{{ (h-1) % 12 + 1 }}:30 {{ 'AM' if h < 12 or h==24 else 'PM' }}</div>
                            {% endfor %}
                        </div>
                        <div class="room-timeline" id="room-{{ room.id }}" data-room-id="{{ room.id }}">
                            {# Create 30‑minute granular time slots (two per hour) so labels & slots align #}
                            {% for h in range(start_hour, end_hour) %}
                                <div class="time-slot" data-hour="{{ h }}" data-minute="0"></div>
                                <div class="time-slot" data-hour="{{ h }}" data-minute="30"></div>
                            {% endfor %}

                            {# Render reservation cards positioned relative to their start slot #}
                            {% for reservation in room.reservations %}
                                {% set res_start_parts = reservation.start_time.split(':') %}
                                {% set res_start_hour = res_start_parts[0]|int %}
                                {% set res_start_min = res_start_parts[1]|int %}
                                {% set slot_index = (res_start_hour - 11) * 2 + (res_start_min // 30) %}
                                {% set top_pos = slot_index * 20 %}
                                {% set card_height = reservation.duration * 40 %}
                                <div class="reservation-card" data-reservation-id="{{ reservation.id }}" data-room-id="{{ room.id }}" data-hour="{{ res_start_hour }}" data-minute="{{ res_start_min }}" data-start-time="{{ reservation.start_time }}" data-end-time="{{ reservation.end_time }}" data-duration="{{ reservation.duration }}" data-top="{{ top_pos }}" data-height="{{ card_height }}">
                                    <div class="time-indicator">
                                        <span class="time-range">{{ reservation.start_time }} - {{ reservation.end_time }}</span>
                                    </div>
                                    <div class="content">
                                        <div class="name-row">
                                            <strong>{{ reservation.contact_name }}</strong>
                                            <span class="people-count">{{ reservation.num_people }}</span>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Reservation Form Modal -->
    <div class="modal fade" id="reservationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span class="en">New Reservation</span>
                        <span class="zh">新预订</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="reservationForm" method="POST" action="{{ url_for('reservation') }}">
                        <input type="hidden" id="reservation_id" name="reservation_id">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-2">
                                    <label for="date">Date <span class="chinese">日期</span></label>
                                    <input type="text" id="date" name="date" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-2">
                                    <label for="room_id" class="bilingual-label horizontal">
                                        <span class="en">Room</span>
                                        <span class="zh">房间</span>
                                    </label>
                                    <select id="room_id" name="room_id" class="form-control">
                                        {% for room in rooms %}
                                        <option value="{{ room.id }}">Room {{ room.id }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-2">
                                    <label for="start_time">Start Time <span class="chinese">开始时间</span></label>
                                    <input type="text" id="start_time" name="start_time" class="form-control"
                                        required>
                                    <div class="invalid-feedback">
                                        Start time must be between 11:00 AM and 12:00 AM (midnight)
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-2">
                                    <label for="end_time">End Time <span class="chinese">结束时间</span></label>
                                    <input type="text" id="end_time" name="end_time" class="form-control"
                                        required>
                                    <div class="invalid-feedback">
                                        End time must be after start time and no later than 1:00 AM
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mb-2" role="alert">
                            <small><strong>Business Hours:</strong> Reservations are only available between
                                11:00 AM
                                and 1:00 AM</small>
                        </div>

                        <div class="quick-duration-buttons mb-2">
                            <button type="button" class="duration-btn" data-hours="0.5">30m</button>
                            <button type="button" class="duration-btn" data-hours="1">1h</button>
                            <button type="button" class="duration-btn" data-hours="2">2h</button>
                            <button type="button" class="duration-btn" data-hours="3">3h</button>
                            <button type="button" class="duration-btn" data-hours="4">4h</button>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="num_people" class="bilingual-label">
                                        <span class="en">Number of People</span>
                                        <span class="zh">人数</span>
                                    </label>
                                    <input type="number" id="num_people" name="num_people" min="1" max="20"
                                        class="form-control" value="1" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="language" class="bilingual-label">
                                        <span class="en">Language</span>
                                        <span class="zh">语言</span>
                                    </label>
                                    <select id="language" name="language" class="form-control">
                                        <option value="en" selected>English</option>
                                        <option value="zh">Mandarin (普通话)</option>
                                        <option value="ja">Japanese (日本語)</option>
                                        <option value="ko">Korean (한국어)</option>
                                        <option value="vi">Vietnamese (Tiếng Việt)</option>
                                        <option value="th">Thai (ไทย)</option>
                                        <option value="other">Other (其他)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group mb-3">
                                    <label for="contact_name" class="bilingual-label">
                                        <span class="en">Contact Name</span>
                                        <span class="zh">联系人姓名</span>
                                    </label>
                                    <input type="text" id="contact_name" name="contact_name" required
                                        class="form-control" placeholder="Required *">
                                    <div class="invalid-feedback">
                                        Please enter a contact name
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="contact_phone" class="bilingual-label">
                                        <span class="en">Contact Phone</span>
                                        <span class="zh">联系电话</span>
                                    </label>
                                    <input type="tel" id="contact_phone" name="contact_phone" required
                                        class="form-control" placeholder="Required *">
                                    <div class="invalid-feedback">
                                        Please enter a valid phone number
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="contact_email" class="bilingual-label">
                                        <span class="en">Contact Email</span>
                                        <span class="zh">电子邮箱</span>
                                    </label>
                                    <input type="email" id="contact_email" name="contact_email"
                                        class="form-control" placeholder="Optional">
                                    <div class="invalid-feedback">
                                        Please enter a valid email address or leave it empty
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion mt-2 mb-2">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="costBreakdownHeader">
                                    <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#costBreakdown">
                                        Cost Breakdown <span class="chinese ms-2">费用明细</span>
                                    </button>
                                </h2>
                                <div id="costBreakdown" class="accordion-collapse collapse">
                                    <div class="accordion-body p-2">
                                        <div class="price-breakdown">
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Room Rate <span
                                                        class="chinese">房间费用</span></span>
                                                <span id="room-rate">$0</span>
                                            </div>
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Time Period Charges <span
                                                        class="chinese">时段费用</span></span>
                                                <div id="period-charges"></div>
                                            </div>
                                            <div class="breakdown-item">
                                                <span class="breakdown-label">Tax (5.5%) <span
                                                        class="chinese">税费</span></span>
                                                <span id="tax-amount">$0</span>
                                            </div>
                                            <div class="breakdown-item total">
                                                <span class="breakdown-label">Total <span
                                                        class="chinese">总计</span></span>
                                                <span id="total-cost">$0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-danger" id="delete-reservation-btn">
                                <span class="en">Delete</span>
                                <span class="zh">删除</span>
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <span class="en">Save</span>
                                <span class="zh">保存</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <!-- Removed flatpickr scripts -->
    <script src="{{ url_for('static', filename='js/reservation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/form-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/enhanced-calendar.js') }}"></script>
    <script src="{{ url_for('static', filename='js/improved-layout.js') }}"></script>
</body>

</html>
